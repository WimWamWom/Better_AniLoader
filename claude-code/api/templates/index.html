<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniLoader</title>
    <style>
        :root {
            --bg: #0d1117;
            --surface: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --text-muted: #8b949e;
            --primary: #58a6ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; }
        header h1 { font-size: 1.4rem; color: var(--primary); }
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }

        /* Cards */
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; margin-bottom: 1rem; }
        .card h2 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--primary); }

        /* Stats row */
        .stats { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; }
        .stat { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1rem 1.5rem; flex: 1; min-width: 120px; text-align: center; }
        .stat .value { font-size: 2rem; font-weight: bold; color: var(--primary); }
        .stat .label { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }

        /* Controls */
        .controls { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; }
        button { border: none; padding: 0.5rem 1.25rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: opacity 0.2s; }
        button:hover { opacity: 0.85; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-success { background: var(--success); color: #000; }
        .btn-warning { background: var(--warning); color: #000; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }

        /* Input */
        input[type="text"], input[type="url"], select {
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.9rem; width: 100%;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); }
        .input-row { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; }
        .input-row input { flex: 1; }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); }
        th { color: var(--text-muted); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
        tr:hover { background: rgba(88,166,255,0.04); }

        /* Badges */
        .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .badge-ok { background: rgba(63,185,80,0.15); color: var(--success); }
        .badge-pending { background: rgba(210,153,34,0.15); color: var(--warning); }
        .badge-error { background: rgba(248,81,73,0.15); color: var(--danger); }

        /* Status indicator */
        #status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 0.5rem; }
        .dot-idle { background: var(--text-muted); }
        .dot-running { background: var(--success); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* Log */
        .log-box { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; max-height: 300px; overflow-y: auto; font-family: 'Fira Code', 'Consolas', monospace; font-size: 0.8rem; line-height: 1.6; white-space: pre-wrap; color: var(--text-muted); }

        /* Toast */
        .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: var(--surface); border: 1px solid var(--primary); padding: 0.75rem 1.25rem; border-radius: 8px; font-size: 0.9rem; z-index: 999; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <header>
        <h1>&#x1f4e6; AniLoader</h1>
        <div>
            <span id="status-dot" class="dot-idle"></span>
            <span id="status-text">Idle</span>
        </div>
    </header>

    <div class="container">
        <!-- Stats -->
        <div class="stats">
            <div class="stat"><div class="value" id="stat-total">-</div><div class="label">Total</div></div>
            <div class="stat"><div class="value" id="stat-active">-</div><div class="label">Active</div></div>
            <div class="stat"><div class="value" id="stat-complete">-</div><div class="label">Complete</div></div>
            <div class="stat"><div class="value" id="stat-german">-</div><div class="label">German</div></div>
            <div class="stat"><div class="value" id="stat-disk">-</div><div class="label">Free GB</div></div>
        </div>

        <!-- Add Series -->
        <div class="card">
            <h2>Serie hinzufügen</h2>
            <div class="input-row">
                <input type="url" id="add-url" placeholder="https://aniworld.to/anime/stream/..." />
                <button class="btn-primary" onclick="addSeries()">Hinzufügen</button>
            </div>
        </div>

        <!-- Download Controls -->
        <div class="card">
            <h2>Download steuern</h2>
            <div class="controls">
                <button class="btn-primary" onclick="startDL('default')">Default</button>
                <button class="btn-success" onclick="startDL('german')">German</button>
                <button class="btn-warning" onclick="startDL('new')">New</button>
                <button class="btn-outline" onclick="startDL('check')">Check</button>
                <button class="btn-danger" onclick="stopDL()">Stop</button>
            </div>
        </div>

        <!-- Series List -->
        <div class="card">
            <h2>Serien &amp; Anime</h2>
            <div class="input-row">
                <input type="text" id="filter-q" placeholder="Suche..." oninput="loadSeries()" />
            </div>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Titel</th>
                        <th>Typ</th>
                        <th>Status</th>
                        <th>Deutsch</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody id="series-body"></tbody>
            </table>
        </div>

        <!-- Logs -->
        <div class="card">
            <h2>Log</h2>
            <div class="log-box" id="log-box">Lade Logs...</div>
            <div style="margin-top:0.5rem;">
                <button class="btn-outline" onclick="loadLogs()">Aktualisieren</button>
            </div>
        </div>
    </div>

    <script>
        const API = '';

        async function api(path, opts = {}) {
            const resp = await fetch(API + path, opts);
            return resp.json();
        }

        // ── Stats ──
        async function loadStats() {
            const data = await api('/counts');
            document.getElementById('stat-total').textContent = data.total ?? '-';
            document.getElementById('stat-active').textContent = data.active ?? '-';
            document.getElementById('stat-complete').textContent = data.complete ?? '-';
            document.getElementById('stat-german').textContent = data.german_complete ?? '-';
            const disk = await api('/disk');
            document.getElementById('stat-disk').textContent = disk.free_gb ?? '-';
        }

        // ── Status polling ──
        async function pollStatus() {
            const data = await api('/status');
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            if (data.status === 'running') {
                dot.className = 'dot-running';
                txt.textContent = 'Running (' + data.mode + ')';
            } else {
                dot.className = 'dot-idle';
                txt.textContent = 'Idle';
            }
        }

        // ── Series list ──
        async function loadSeries() {
            const q = document.getElementById('filter-q').value;
            let path = '/database';
            if (q) path += '?q=' + encodeURIComponent(q);
            const data = await api(path);
            const tbody = document.getElementById('series-body');
            tbody.innerHTML = '';
            for (const s of data) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.id}</td>
                    <td><a href="${s.url}" target="_blank" style="color:var(--primary);text-decoration:none">${s.title}</a></td>
                    <td>${s.content_type}</td>
                    <td>${s.complete ? '<span class="badge badge-ok">OK</span>' : '<span class="badge badge-pending">Offen</span>'}</td>
                    <td>${s.german_complete ? '<span class="badge badge-ok">Ja</span>' : '<span class="badge badge-pending">Nein</span>'}</td>
                    <td><button class="btn-danger" style="padding:0.25rem 0.6rem;font-size:0.8rem" onclick="deleteSeries(${s.id})">&#x2716;</button></td>
                `;
                tbody.appendChild(tr);
            }
        }

        // ── Actions ──
        async function addSeries() {
            const url = document.getElementById('add-url').value.trim();
            if (!url) return;
            const data = await api('/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url }) });
            toast(data.msg || data.title || 'Hinzugefügt');
            document.getElementById('add-url').value = '';
            loadSeries();
            loadStats();
        }

        async function deleteSeries(id) {
            await api('/series/' + id, { method: 'DELETE' });
            loadSeries();
            loadStats();
        }

        async function startDL(mode) {
            const data = await api('/start?mode=' + mode, { method: 'POST' });
            toast(data.msg || 'Started');
            pollStatus();
        }

        async function stopDL() {
            const data = await api('/stop', { method: 'POST' });
            toast(data.msg || 'Stopped');
            pollStatus();
        }

        async function loadLogs() {
            const data = await api('/logs?lines=150');
            document.getElementById('log-box').textContent = (data.lines || []).join('\n');
            const box = document.getElementById('log-box');
            box.scrollTop = box.scrollHeight;
        }

        function toast(msg) {
            const el = document.createElement('div');
            el.className = 'toast';
            el.textContent = msg;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        // ── Init ──
        loadStats();
        loadSeries();
        loadLogs();
        setInterval(pollStatus, 5000);
        setInterval(loadStats, 30000);
    </script>
</body>
</html>
